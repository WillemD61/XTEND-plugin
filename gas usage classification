--[[
This dzvents script classifies gas usage into 3 different categories onto virtual COUNTER devices for heatinggas, hotwatergas and cookinggas.

This script checks the status of two switch devices in the past 5 minutes, since the gas increase is received with a delay of max 5 minutes.
The switch devices are updated by a separate dzvents script that read the boilerstatus of the Xtend.

Known limitations:
- cooking gas is not measured separately so will also be included in heating or hot water gas, unless both were not active

Note the script can be triggered in very quick succession if two switches are update almost simultaneously. No problem has been observed as result of this.

Note: don't use virtual GAS devices to track the types of gas usage. Use virtual COUNTER devices instead and update those manually (with edit device) to type GAS with divider 1000 once created.
This is because resets of GAS counters (not only counterToday but also counter) have been observed after midnight, (update 04/10/2022 : this problem seems to be solved in latest beta version)
 ]]--
 
local idxGasP1=2                  -- idx of P1 meter Gas usage
local idxCentralHeatingActive=316 -- idx of CH active switch, updated by script "gas usage detect"
local idxHotWaterActive=317       -- idx of HW-active switch, updated by script "gas usage detect"

local idxCentralHeatingGas=87    -- 3 virtual COUNTER devices for tracking type of GAS usage
local idxCookingGas=88
local idxHotWaterGas=89 

return {
	on = {
		devices = {
			idxGasP1,
		},
 	},
	data = {
            -- a variable to check not only an update but an actual increase of the gas meter
            previousgascounter = { initial = 0 },
    },        
	logging = {
		level = domoticz.LOG_INFO,
		marker = 'gas classification new',
	},
	execute = function(domoticz, item)

	    -- real classification takes place each time GAS meter value changes 
		if item.idx==idxGasP1 then
	        local currentGas = domoticz.devices(idxGasP1).counter
	        local increasegas = 0
	        local currentValue=0
	        
	        domoticz.log('Triggered by GASP1 with value ' .. currentGas, domoticz.LOG_INFO)
	        domoticz.log('while previous GASP1    value ' .. domoticz.data.previousgascounter, domoticz.LOG_INFO)
		    domoticz.log('Device ' .. item.name .. ' was updated', domoticz.LOG_INFO)
		    

		    domoticz.log('Hot Water Gas counter value ' .. domoticz.devices(idxHotWaterGas).counter .. ' ', domoticz.LOG_INFO)
    		domoticz.log('Central Heating Gas counter ' .. domoticz.devices(idxCentralHeatingGas).counter .. ' ', domoticz.LOG_INFO)
    		domoticz.log('Cooking Gas counter ' .. domoticz.devices(idxCookingGas).counter .. ' ', domoticz.LOG_INFO)

		    if currentGas>domoticz.data.previousgascounter then -- not only an update but a real increase. 
		        increasegas = domoticz.utils.round(currentGas - domoticz.data.previousgascounter,3)
		        domoticz.log('Current value of Device ' .. item.name .. currentGas .. 'm3', domoticz.LOG_INFO)
		        domoticz.log('Previousgascounter ' .. domoticz.data.previousgascounter .. 'm3', domoticz.LOG_INFO)
		        domoticz.log('Value of Device ' .. item.name .. ' has increased by ' .. increasegas .. 'm3', domoticz.LOG_INFO)
		        
		        if domoticz.devices(idxHotWaterActive).state=='On' then
		            -- increase due to DHW usage
		            domoticz.log('Value of Device ' .. item.name .. ' has increased as result of hot water (+ possibly cooking) usage', domoticz.LOG_INFO)
                    currentValue=domoticz.devices(idxHotWaterGas).counter
                    domoticz.devices(idxHotWaterGas).updateCounter(increasegas*1000+currentValue*1000)  -- update value must be in dm3
		        else
		            if domoticz.devices(idxCentralHeatingActive).state=='On' then
		                --increase due to CH usage
		                domoticz.log('Value of Device ' .. item.name .. ' has increased as result of central heating (+ possibly cooking) usage', domoticz.LOG_INFO)
		                currentValue=domoticz.devices(idxCentralHeatingGas).counter
                        domoticz.devices(idxCentralHeatingGas).updateCounter(increasegas*1000+currentValue*1000)  -- update value must be in dm3
		            else
		                -- currently nothing active, look in the past 5 minutes 
		                if domoticz.devices(idxHotWaterActive).lastUpdate.minutesAgo<5 then
		                    -- DHW has been active
		                    domoticz.log('Value of Device ' .. item.name .. ' has increased as result of hot water (+ possibly cooking) usage', domoticz.LOG_INFO)
                            currentValue=domoticz.devices(idxHotWaterGas).counter
                            domoticz.devices(idxHotWaterGas).updateCounter(increasegas*1000+currentValue*1000)  -- update value must be in dm3
		                else
		                    if domoticz.devices(idxCentralHeatingActive).lastUpdate.minutesAgo<5 then
		                        -- CH has been active
		                		domoticz.log('Value of Device ' .. item.name .. ' has increased as result of central heating (+ possibly cooking) usage', domoticz.LOG_INFO)
		                        currentValue=domoticz.devices(idxCentralHeatingGas).counter
                                domoticz.devices(idxCentralHeatingGas).updateCounter(increasegas*1000+currentValue*1000)  -- update value must be in dm3
		                    else
		                        -- nothing active now or in the last 5 minutes --> cooking
		                        domoticz.log('Value of Device ' .. item.name .. ' has increased as result of cooking usage', domoticz.LOG_INFO)
		                        currentValue=domoticz.devices(idxCookingGas).counter
                                domoticz.devices(idxCookingGas).updateCounter(increasegas*1000+currentValue*1000)  -- update value must be in dm3
                            end    
		                end     
		            end
		        end      
		        domoticz.data.previousgascounter=currentGas
            else
		        domoticz.log('Value of Device ' .. item.name .. ' has stayed the same', domoticz.LOG_INFO)
		    end
		end    

	end
}

